<!DOCTYPE html>

<html lang="en">
<head>
<meta charset="utf-8"/>
<title>Urinary System Quiz</title>
<link href="https://cdn.jsdelivr.net/npm/bootstrap@4.6.2/dist/css/bootstrap.min.css" rel="stylesheet"/>
<style>
    body {
      padding: 2rem;
      background-color: #f8f9fa;
    }
    .category-columns {
      display: flex;
      gap: 2rem;
      flex-wrap: wrap;
    }
    .category-column {
      flex: 1 1 45%;
      min-width: 300px;
    }
    .category-section {
      margin-bottom: 2rem;
    }
    .category-group {
      margin-left: 1rem;
    }
    .subcategory {
      margin-left: 3.5rem;
    }
    label {
      margin-left: 0.3rem;
    }
    .card {
      margin-bottom: 1.5rem;
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.05);
      border-radius: 0.75rem;
      background: #ffffff;
    }
    .card-body {
      background-color: #e9f5ff;
      border-radius: 0.75rem;
    }
    .card-title {
      font-weight: bold;
      font-size: 1.2rem;
      color: #0056b3;
    }
    strong {
      display: inline-block;
      margin-top: 1rem;
      color: #343a40;
    }
    .subtopic-header {
      margin-bottom: 0.5rem;
      margin-left: 1.5rem;
    }
  </style>
</head>
<body>
<div class="container">
<h2 class="mb-4 text-primary">Urinary System Quiz</h2>
<p class="lead">Select one or more topics from the list below to generate a custom quiz. You can choose specific categories or entire sections. Once you're ready, you'll be able to start the quiz and answer questions one at a time.</p>
<div class="form-group">
<label><strong>Select Topic Categories</strong></label>
<div class="row category-columns">
<!-- I. Anatomy & Physiology -->
<div class="category-column">
<div class="card">
<div class="card-body">
<h5 class="card-title"><input type="checkbox"/> <label>I. Anatomy &amp; Physiology</label></h5>
<div class="category-group">
<div class="subtopic-header"><input type="checkbox"/> <label><strong>Structure &amp; Development</strong></label></div>
<div class="subcategory structure-development">
<div><input class="form-check-input" type="checkbox" value="anatomy"/> <label>Anatomy of the urinary system</label></div>
<div><input class="form-check-input" type="checkbox" value="development"/> <label>Development and congenital abnormalities</label></div>
</div>
<div class="subtopic-header"><input type="checkbox"/> <label><strong>Filtration &amp; Solute Transport</strong></label></div>
<div class="subcategory filtration-transport">
<div><input class="form-check-input" type="checkbox" value="gfr"/> <label>The glomerulus &amp; GFR</label></div>
<div><input class="form-check-input" type="checkbox" value="clearance"/> <label>Clearance, tubuloglomerular feedback, myogenic feedback</label></div>
<div><input class="form-check-input" type="checkbox" value="reabsorption"/> <label>Reabsorption of solutes</label></div>
<div><input class="form-check-input" type="checkbox" value="sodium"/> <label>Sodium/chloride/water reabsorption</label></div>
<div><input class="form-check-input" type="checkbox" value="gradient"/> <label>Corticopapillary gradient, countercurrent exchange</label></div>
<div><input class="form-check-input" type="checkbox" value="diuretics"/> <label>Diuretics</label></div>
</div>
<div class="subtopic-header"><input type="checkbox"/> <label><strong>Fluid &amp; Electrolyte Homeostasis</strong></label></div>
<div class="subcategory fluid-homeostasis">
<div><input class="form-check-input" type="checkbox" value="osmolality"/> <label>Body fluid osmolality</label></div>
<div><input class="form-check-input" type="checkbox" value="volume"/> <label>Volume control</label></div>
<div><input class="form-check-input" type="checkbox" value="replacement"/> <label>Fluid replacement therapy</label></div>
<div><input class="form-check-input" type="checkbox" value="disorders"/> <label>Osmolality disorders</label></div>
<div><input class="form-check-input" type="checkbox" value="acidbase"/> <label>Acid-base balance</label></div>
<div><input class="form-check-input" type="checkbox" value="potassium"/> <label>Potassium regulation</label></div>
<div><input class="form-check-input" type="checkbox" value="hormonal"/> <label>Hormonal control (ADH, aldosterone)</label></div>
</div>
</div>
</div>
</div>
</div>
<!-- II. Disease & Dysfunction -->
<div class="category-column">
<div class="card">
<div class="card-body">
<h5 class="card-title"><input type="checkbox"/> <label>II. Disease &amp; Dysfunction</label></h5>
<div class="category-group">
<div class="subtopic-header"><input type="checkbox"/> <label><strong>Kidney Injury &amp; Disorders</strong></label></div>
<div class="subcategory kidney-disorders">
<div><input class="form-check-input" type="checkbox" value="aki"/> <label>Acute kidney injury (AKI)</label></div>
<div><input class="form-check-input" type="checkbox" value="ckd"/> <label>Chronic kidney disease (CKD)</label></div>
<div><input class="form-check-input" type="checkbox" value="glomerulonephritis"/> <label>Glomerulonephritis</label></div>
<div><input class="form-check-input" type="checkbox" value="histology"/> <label>Histology of glomerulus</label></div>
</div>
<div class="subtopic-header"><input type="checkbox"/> <label><strong>Lower Urinary Tract Disorders</strong></label></div>
<div class="subcategory lower-tract">
<div><input class="form-check-input" type="checkbox" value="micturition"/> <label>Micturition</label></div>
<div><input class="form-check-input" type="checkbox" value="incontinence"/> <label>Incontinence</label></div>
<div><input class="form-check-input" type="checkbox" value="utis"/> <label>UTIs</label></div>
<div><input class="form-check-input" type="checkbox" value="obstructions"/> <label>Obstructions</label></div>
</div>
<div class="subtopic-header"><input type="checkbox"/> <label><strong>Neoplasia</strong></label></div>
<div class="subcategory neoplasia">
<div><input class="form-check-input" type="checkbox" value="kidneycancer"/> <label>Carcinoma of kidney</label></div>
<div><input class="form-check-input" type="checkbox" value="bladdercancer"/> <label>Carcinoma of bladder</label></div>
<div><input class="form-check-input" type="checkbox" value="prostatecancer"/> <label>Carcinoma of prostate</label></div>
</div>
<div class="subtopic-header"><input type="checkbox"/> <label><strong>Prostate Pathology</strong></label></div>
<div class="subcategory prostate">
<div><input class="form-check-input" type="checkbox" value="prostate"/> <label>Benign and malignant prostate conditions</label></div>
</div>
</div>
</div>
</div>
</div>
<!-- Question slider -->
<div class="form-group mt-4">
<label for="questionRange"><strong>Select Number of Questions:</strong></label>
<input class="custom-range" id="questionRange" max="20" min="1" oninput="document.getElementById('rangeValue').textContent = this.value" type="range" value="10"/>
<p class="mt-2">Number of questions: <strong><span id="rangeValue">10</span></strong></p>
</div>
<div class="mt-3" id="questionTypeSelector">
<label><strong>Question Type:</strong></label><br/>
<div class="form-check form-check-inline">
<input class="form-check-input" id="sbaOnly" name="questionType" type="radio" value="MCQ"/>
<label class="form-check-label" for="sbaOnly">SBAs only</label>
</div>
<div class="form-check form-check-inline">
<input class="form-check-input" id="saqOnly" name="questionType" type="radio" value="Short Answer"/>
<label class="form-check-label" for="saqOnly">SAQs only</label>
</div>
<div class="form-check form-check-inline">
<input checked="" class="form-check-input" id="bothTypes" name="questionType" type="radio" value="Both"/>
<label class="form-check-label" for="bothTypes">Both</label>
</div>
</div>
</div>
<script>
  // Add toggle logic for heading-level checkboxes
  document.querySelectorAll('.subtopic-header input[type="checkbox"]').forEach(headerCb => {
    headerCb.addEventListener('change', () => {
      const group = headerCb.closest('.subtopic-header').nextElementSibling;
      if (group && group.classList.contains('subcategory')) {
        group.querySelectorAll('input[type="checkbox"]').forEach(childCb => {
          childCb.checked = headerCb.checked;
        });
        updateMaxQuestions();
      }
    });
  });
  const questionCounts = {
    anatomy: 5,
    development: 4,
    gfr: 6,
    clearance: 3,
    reabsorption: 5,
    sodium: 6,
    gradient: 4,
    diuretics: 3,
    osmolality: 4,
    volume: 5,
    replacement: 2,
    disorders: 3,
    acidbase: 4,
    potassium: 3,
    hormonal: 4,
    aki: 5,
    ckd: 5,
    glomerulonephritis: 3,
    histology: 4,
    micturition: 3,
    incontinence: 3,
    utis: 3,
    obstructions: 3,
    kidneycancer: 2,
    bladdercancer: 2,
    prostatecancer: 2,
    prostate: 3
  };

  function updateMaxQuestions() {
    const selected = document.querySelectorAll("input.form-check-input:checked");
    let total = 0;
    selected.forEach(cb => {
      total += questionCounts[cb.value] || 0;
    });
    const range = document.getElementById("questionRange");
    const rangeDisplay = document.getElementById("rangeValue");

    if (total > 0) {
      range.max = total;
      if (parseInt(range.value) > total) {
        range.value = total;
      } else if (parseInt(range.value) < 1) {
        range.value = 1;
      }
      rangeDisplay.textContent = range.value;
    } else {
      range.max = 20;
      range.value = 10;
      rangeDisplay.textContent = 10;
    }
  }

  document.querySelectorAll("input.form-check-input").forEach(cb => {
    cb.addEventListener("change", updateMaxQuestions);
  });
  // Add toggle logic for section-level checkboxes
  document.querySelectorAll('.card-title input[type="checkbox"]').forEach(sectionCb => {
    sectionCb.addEventListener('change', () => {
      const body = sectionCb.closest('.card-body');
      if (body) {
        body.querySelectorAll('input[type="checkbox"]').forEach(childCb => {
          if (childCb !== sectionCb) {
            childCb.checked = sectionCb.checked;
          }
        });
        updateMaxQuestions();
      }
    });
  });
</script>
<!-- Quiz Modal -->
<div aria-hidden="true" aria-labelledby="quizModalLabel" class="modal fade" id="quizModal" role="dialog" tabindex="-1">
<div class="modal-dialog modal-lg" role="document">
<div class="modal-content">
<div class="modal-header">
<h5 class="modal-title" id="quizModalLabel">Quiz Question</h5>
<button aria-label="Close" class="close" data-dismiss="modal" onclick="endQuiz()" type="button">
<span aria-hidden="true">×</span>
</button>
</div>
<div class="modal-body"><p class="text-muted mb-2" id="quizProgress">Question 1 of X</p><div id="quizContainer">
<!-- Question content will go here -->
</div>
<div class="modal-footer">
<button class="btn btn-secondary" id="nextQuestion" type="button">Next</button>
</div>
</div>
</div>
</div>
<script src="https://code.jquery.com/jquery-3.5.1.slim.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/bootstrap@4.6.2/dist/js/bootstrap.bundle.min.js"></script>
<script>

// === Embedded Quiz Questions ===
let score = 0;
let userResponses = [];

const quizQuestions = [
  {
    "ID": 1,
    "Type": "MCQ",
    "Category": "gfr",
    "Subcategory": "",
    "Question": "What does GFR measure?",
    "Options": "Blood pressure|Filtration|Osmosis|Tubular reabsorption",
    "Answer": "Filtration",
    "Explanation": "GFR reflects the kidney's filtering capacity."
  },
  {
    "ID": 2,
    "Type": "MCQ",
    "Category": "acidbase",
    "Subcategory": "",
    "Question": "What is the normal blood pH?",
    "Options": "6.9\u20137.1|7.0\u20137.2|7.35\u20137.45|7.45\u20137.55",
    "Answer": "7.35\u20137.45",
    "Explanation": "The normal blood pH range is 7.35 to 7.45."
  },
  {
    "ID": 3,
    "Type": "MCQ",
    "Category": "utis",
    "Subcategory": "",
    "Question": "Which symptom is most typical of a UTI?",
    "Options": "Chest pain|Dysuria|Vomiting|Palpitations",
    "Answer": "Dysuria",
    "Explanation": "Dysuria (painful urination) is a key sign of UTI."
  },
  {
    "ID": 4,
    "Type": "MCQ",
    "Category": "micturition",
    "Subcategory": "",
    "Question": "What muscle controls voluntary urination?",
    "Options": "Detrusor|Trigone|External sphincter|Ureter",
    "Answer": "External sphincter",
    "Explanation": "The external sphincter is under voluntary control."
  },
  {
    "ID": 5,
    "Type": "MCQ",
    "Category": "anatomy",
    "Subcategory": "",
    "Question": "Where are the renal pyramids located?",
    "Options": "Cortex|Medulla|Pelvis|Capsule",
    "Answer": "Medulla",
    "Explanation": "Renal pyramids lie within the medulla of the kidney.",
    "Image": "Kidney-lettered2.jpg.jpg"
  },
  {
    "ID": 6,
    "Type": "Short Answer",
    "Category": "gfr",
    "Subcategory": "",
    "Question": "Name one factor that increases GFR.",
    "Options": "",
    "Answer": "Increased renal blood flow",
    "Explanation": "Higher blood flow increases glomerular pressure and filtration."
  },
  {
    "ID": 7,
    "Type": "Short Answer",
    "Category": "acidbase",
    "Subcategory": "",
    "Question": "What buffer system is most important in the blood?",
    "Options": "",
    "Answer": "Bicarbonate buffer system",
    "Explanation": "The bicarbonate buffer system regulates pH."
  },
  {
    "ID": 8,
    "Type": "Short Answer",
    "Category": "utis",
    "Subcategory": "",
    "Question": "List one common organism that causes UTIs.",
    "Options": "",
    "Answer": "E. coli",
    "Explanation": "Escherichia coli is the most common UTI pathogen."
  },
  {
    "ID": 9,
    "Type": "MCQ",
    "Category": "anatomy",
    "Subcategory": "",
    "Question": "What structure is labeled D in the image?",
    "Options": "Capsule|Renal pelvis|Renal vein|Ureter",
    "Answer": "Ureter",
    "Explanation": "The ureter carries urine from the kidney to the bladder.",
    "Image": "Kidney-lettered2.jpg"
  },
  {
    "ID": 10,
    "Type": "Short Answer",
    "Category": "anatomy",
    "Subcategory": "",
    "Question": "Label structures A, C, H, and L on the image.",
    "Options": "",
    "Answer": "A = interlobar arteries and veins; C = renal vein; H = renal pelvis; L = nephrons",
    "Explanation": "These are key labelled anatomical landmarks of the kidney.",
    "Image": "Kidney-lettered2.jpg"
  }
];
let current = 0;

function getSelectedCategories() {
  return Array.from(document.querySelectorAll("input.form-check-input:checked")).map(cb => cb.value);
}

function getFilteredQuestions() {
  const selected = getSelectedCategories();
  return quizQuestions.filter(q => selected.includes(q.Category));
}


function displayQuestion(question) {
  updateProgressBar();

  const container = document.getElementById("quizContainer");
  container.innerHTML = "";

  
  if (question.Image) {
    const imgEl = document.createElement("img");
    imgEl.src = question.Image;
    imgEl.alt = "Question Image";
    imgEl.style.maxWidth = "100%";
    imgEl.className = "img-fluid mb-3 d-block mx-auto";
    container.appendChild(imgEl);
  }

  const qText = document.createElement("p");
  qText.innerHTML = "<strong>Question:</strong> " + question.Question;
  container.appendChild(qText);

  const answerContainer = document.createElement("div");
  answerContainer.id = "answerContainer";
  container.appendChild(answerContainer);

  const feedbackContainer = document.createElement("div");
  feedbackContainer.id = "feedbackContainer";
  feedbackContainer.className = "mt-3";
  container.appendChild(feedbackContainer);

  const submitBtn = document.createElement("button");
  submitBtn.className = "btn btn-success mt-3";
  submitBtn.textContent = "Submit Answer";
  submitBtn.onclick = () => checkAnswer(question);
  container.appendChild(submitBtn);

  if (question.Type === "MCQ") {
    const options = question.Options.split("|");
    options.forEach((opt, index) => {
      const optEl = document.createElement("div");
      optEl.innerHTML = `<input type="radio" name="option" id="opt${index}" value="${opt}"> <label for="opt${index}">${opt}</label>`;
      answerContainer.appendChild(optEl);
    });
  } else if (question.Type === "Short Answer") {
    const inputEl = document.createElement("textarea");
    inputEl.id = "shortAnswer";
    inputEl.rows = 3;
    inputEl.className = "form-control";
    answerContainer.appendChild(inputEl);
  }
}

function checkAnswer(question) {
  const feedback = document.getElementById("feedbackContainer");
  feedback.innerHTML = "";

  if (question.Type === "MCQ") {
    const selected = document.querySelector('input[name="option"]:checked');
    if (!selected) {
      feedback.innerHTML = "<div class='text-danger'>Please select an option.</div>";
      return;
    }
    const userAnswer = selected.value;
    
    const correct = userAnswer.toLowerCase() === question.Answer.toLowerCase();
    if (correct) score++;
    userResponses.push({ question: question.Question, yourAnswer: userAnswer, correctAnswer: question.Answer, correct: correct, explanation: question.Explanation });


    feedback.innerHTML = correct
      ? "<div class='text-success'><strong>✓ Correct!</strong></div>"
      : `<div class='text-danger'><strong>✗ Incorrect.</strong> Correct answer: <em>${question.Answer}</em></div>`;
  } else {
    
    const userAnswer = document.getElementById("shortAnswer").value.trim();
    userResponses.push({ question: question.Question, yourAnswer: userAnswer, correctAnswer: question.Answer, correct: null, explanation: question.Explanation });

    feedback.innerHTML = `<div class='text-info'><strong>Model Answer:</strong> <em>${question.Answer}</em></div>`;
  }

  if (question.Explanation) {
    const explanation = document.createElement("div");
    explanation.className = "mt-2";
    explanation.innerHTML = "<strong>Explanation:</strong> " + question.Explanation;
    feedback.appendChild(explanation);
  }

  
  document.getElementById("nextQuestion").style.display = "inline-block";
  const submitBtn = document.querySelector("#quizContainer button.btn-success");
  if (submitBtn) submitBtn.style.display = "none";

}


function updateProgressBar() {
  const progress = document.getElementById("quizProgress");
  progress.textContent = `Question ${current + 1} of ${selectedQs.length}`;
}

function nextQuestion() {

  current++;
  if (current < selectedQs.length) {
    displayQuestion(selectedQs[current]);
    document.getElementById("nextQuestion").style.display = "none";
  } else {
    
    showSummary();

    document.getElementById("nextQuestion").style.display = "none";
  }
}


function showSummary() {
  const container = document.getElementById("quizContainer");
  container.innerHTML = "<h5>Quiz Summary</h5>";
  const table = document.createElement("table");
  table.className = "table table-bordered mt-3";
  const thead = document.createElement("thead");
  thead.innerHTML = "<tr><th>#</th><th>Question</th><th>Your Answer</th><th>Correct Answer</th><th>Result</th><th>Explanation</th></tr>";
  table.appendChild(thead);
  const tbody = document.createElement("tbody");
  userResponses.forEach((resp, i) => {
    const row = document.createElement("tr");
    row.innerHTML = `<td>${i + 1}</td><td>${resp.question}</td><td>${resp.yourAnswer}</td><td>${resp.correctAnswer}</td><td>${
      resp.correct === null ? "—" : resp.correct ? "✅" : "✗"
    }</td><td>${resp.explanation || ""}</td>`;
    tbody.appendChild(row);
  });
  table.appendChild(tbody);
  container.appendChild(table);
  const result = document.createElement("p");
  result.className = "mt-3 font-weight-bold";
  result.textContent = `You answered ${score} out of ${selectedQs.filter(q => q.Type === "MCQ").length} MCQs correctly.`;
  container.appendChild(result);
  document.getElementById("nextQuestion").style.display = "none";
}

function startQuiz() {
  score = 0;
  userResponses = [];

  const questions = getFilteredQuestions();
  const n = parseInt(document.getElementById("questionRange").value);
  selectedQs = questions.slice(0, n);
  current = 0;
  displayQuestion(selectedQs[current]);
  $('#quizModal').modal('show');
  document.getElementById("nextQuestion").style.display = "none";
}

function endQuiz() {
  $('#quizModal').modal('hide');
}

document.addEventListener("DOMContentLoaded", () => {
  const startBtn = document.createElement("button");
  startBtn.className = "btn btn-primary mt-3";
  startBtn.textContent = "Start Quiz";
  startBtn.onclick = startQuiz;

  document.body.appendChild(startBtn);
  document.getElementById("nextQuestion").onclick = nextQuestion;
});</script>
</div></div></div>
<script>
document.addEventListener("DOMContentLoaded", () => {
  const counts = {
    anatomy: 5,
    development: 4,
    gfr: 6,
    clearance: 3,
    reabsorption: 5,
    sodium: 6,
    gradient: 4,
    diuretics: 3,
    osmolality: 4,
    volume: 5,
    replacement: 2,
    disorders: 3,
    acidbase: 4,
    potassium: 3,
    hormonal: 4,
    aki: 5,
    ckd: 5,
    glomerulonephritis: 3,
    histology: 4,
    micturition: 3,
    incontinence: 3,
    utis: 3,
    obstructions: 3,
    kidneycancer: 2,
    bladdercancer: 2,
    prostatecancer: 2,
    prostate: 3
  };

  document.querySelectorAll("input.form-check-input").forEach(cb => {
    const val = cb.value;
    const label = cb.nextElementSibling;
    if (counts[val] && label && !label.textContent.includes("(")) {
      label.textContent += ` (${counts[val]})`;
    }
  });
});
</script>
<script>
function getSelectedQuestionType() {
  const selected = document.querySelector("input[name='questionType']:checked");
  return selected ? selected.value : "Both";
}

function getSelectedCategories() {
  return Array.from(document.querySelectorAll("input.form-check-input:checked")).map(cb => cb.value);
}

function getFilteredQuestions() {
  const selectedCats = getSelectedCategories();
  const selectedType = getSelectedQuestionType();

  return quizQuestions.filter(q =>
    selectedCats.includes(q.Category) &&
    (selectedType === "Both" || q.Type === selectedType)
  );
}

function exportToAnkiCSV() {
  const questions = getFilteredQuestions();
  if (questions.length === 0) {
    alert("Please select at least one category and question type.");
    return;
  }

  const csvRows = [["Front", "Back", "Tags"]];
  questions.forEach(q => {
    const category = q.Category || "";
    let front = "", back = "";
    if (q.Type === "MCQ") {
      const options = q.Options.split("|").map(opt => "• " + opt.trim()).join("<br>");
      front = `${q.Question}<br><br>${options}`;
      back = `<b>Answer:</b> ${q.Answer}<br><br><b>Explanation:</b> ${q.Explanation || ""}`;
    } else {
      front = q.Question;
      back = `<b>Model Answer:</b> ${q.Answer}<br><br><b>Explanation:</b> ${q.Explanation || ""}`;
    }
    csvRows.push([front, back, category]);
  });

  const csvContent = csvRows.map(row =>
    row.map(field => '"' + field.replace(/"/g, '""') + '"').join(",")
  ).join("\n");

  const blob = new Blob([csvContent], { type: "text/csv;charset=utf-8;" });
  const link = document.createElement("a");
  link.setAttribute("href", URL.createObjectURL(blob));
  link.setAttribute("download", "urinary_quiz_anki_cards.csv");
  link.style.display = "none";
  document.body.appendChild(link);
  link.click();
  document.body.removeChild(link);
}

document.addEventListener("DOMContentLoaded", () => {
  const ankiBtn = document.createElement("button");
  ankiBtn.className = "btn btn-outline-secondary mt-3 ml-2";
  ankiBtn.textContent = "Download Selected for Anki";
  ankiBtn.onclick = exportToAnkiCSV;

  const startBtn = document.querySelector("button.btn-primary");
  if (startBtn && startBtn.parentNode) {
    startBtn.parentNode.insertBefore(ankiBtn, startBtn.nextSibling);
  } else {
    document.body.appendChild(ankiBtn);
  }

  const startQuiz = window.startQuiz;
  window.startQuiz = function() {
    const questions = getFilteredQuestions();
    const n = parseInt(document.getElementById("questionRange").value);
    selectedQs = questions.slice(0, n);
    current = 0;
    score = 0;
    userResponses = [];
    if (selectedQs.length === 0) {
      alert("No questions match your selected filters.");
      return;
    }
    displayQuestion(selectedQs[current]);
    $('#quizModal').modal('show');
    document.getElementById("nextQuestion").style.display = "none";
  };
});
</script>
<script>
function shuffleArray(array) {
  for (let i = array.length - 1; i > 0; i--) {
    const j = Math.floor(Math.random() * (i + 1));
    [array[i], array[j]] = [array[j], array[i]];
  }
}

function selectRandomizedQuestionsBalanced(filtered, selectedCats, n) {
  const grouped = {};
  selectedCats.forEach(cat => grouped[cat] = []);
  filtered.forEach(q => {
    if (grouped[q.Category]) grouped[q.Category].push(q);
  });

  let selected = [];
  const perCat = Math.floor(n / selectedCats.length);
  const remainder = n % selectedCats.length;

  selectedCats.forEach((cat, idx) => {
    shuffleArray(grouped[cat]);
    const take = perCat + (idx < remainder ? 1 : 0);
    selected = selected.concat(grouped[cat].slice(0, take));
  });

  shuffleArray(selected);
  return selected;
}

document.addEventListener("DOMContentLoaded", () => {
  const originalStartQuiz = window.startQuiz;
  window.startQuiz = function() {
    const selectedCats = getSelectedCategories();
    const filtered = getFilteredQuestions();
    const n = parseInt(document.getElementById("questionRange").value);

    if (filtered.length === 0 || selectedCats.length === 0) {
      alert("Please select at least one category and question type.");
      return;
    }

    selectedQs = selectRandomizedQuestionsBalanced(filtered, selectedCats, n);
    if (selectedQs.length === 0) {
      alert("No questions match your filters.");
      return;
    }

    current = 0;
    score = 0;
    userResponses = [];
    displayQuestion(selectedQs[current]);
    $('#quizModal').modal('show');
    document.getElementById("nextQuestion").style.display = "none";
  };
});
</script>
</body>
</html>
